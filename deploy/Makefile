all:

TARGETS := $(patsubst .src/%.zml,%,$(wildcard .src/*.zml))

.PHONY: all
all:
	@cat $(MAKEFILE_LIST) | grep -v '^\t' | grep -E '^[^:]+:.*?## .*$$' | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'


gen: $(TARGETS:%=sh/%) $(TARGETS:%=cfn/%.yml) sh/deploy_all


cfn sh:
	mkdir -p $@


yml__%.yml.tmp: .src/%.zml
	zaml -i $< -o $@


SH_TEMPLATE := ../template/sh_deploy.sh.jinja
sh/%: yml__%.yml.tmp $(SH_TEMPLATE) sh
	genja -i $(SH_TEMPLATE) -p $< -k DeployScript -o $@
	chmod 755 $@


cfn/%.yml: yml__%.yml.tmp cfn
	echo '# Code generated by Makefile. DO NOT EDIT.' > $@
	echo >> $@
	yq '.CloudFormation' $< -y >> $@


DEPLOY_ALL_TEMPLATE := ../template/sh_deploy_all.sh.jinja
sh/deploy_all: ../template/genja_custom.py $(DEPLOY_ALL_TEMPLATE) $(wildcard .src/*.zml) sh
	genja -i $(DEPLOY_ALL_TEMPLATE) -c $< -o $@
	chmod 755 $@
